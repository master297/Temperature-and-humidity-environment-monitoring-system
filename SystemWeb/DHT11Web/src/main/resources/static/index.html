<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½å®¶å±…ç›‘æ§ä¸­å¿ƒ</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }

        /* ä»ªè¡¨ç›˜åŒºåŸŸæ ·å¼ */
        .status-panel { display: flex; justify-content: space-around; margin-bottom: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 10px; }
        .card { text-align: center; padding: 15px; border-radius: 8px; width: 30%; box-shadow: 0 2px 5px rgba(0,0,0,0.05); background: white; }
        .card h3 { margin: 0 0 10px 0; color: #666; font-size: 16px; }
        .card .value { font-size: 28px; font-weight: bold; color: #333; }

        /* é£æ‰‡çŠ¶æ€ç‰¹å®šæ ·å¼ */
        .fan-off { color: #28a745; } /* ç»¿è‰²è¡¨ç¤ºå®‰å…¨/å…³é—­ */
        .fan-on { color: #dc3545; animation: blink 2s infinite; } /* çº¢è‰²é—ªçƒè¡¨ç¤ºå¼€å¯ */

        /* æŒ‰é’®æ ·å¼ */
        .btn-control {
            margin-top: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn-control:hover { background-color: #0056b3; }
        .btn-control:active { transform: scale(0.98); }

        /* å›¾è¡¨å®¹å™¨ */
        #main { width: 100%; height: 400px; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ  æ™ºèƒ½å®¶å±…ç¯å¢ƒç›‘æ§ç³»ç»Ÿ</h1>

    <div class="status-panel">
        <div class="card">
            <h3>å½“å‰æ¸©åº¦</h3>
            <div id="currentTemp" class="value">-- Â°C</div>
        </div>
        <div class="card">
            <h3>å½“å‰æ¹¿åº¦</h3>
            <div id="currentHumi" class="value">-- %</div>
        </div>
        <div class="card">
            <h3>é£æ‰‡çŠ¶æ€ (è‡ªåŠ¨)</h3>
            <div id="fanStatus" class="value fan-off">æ£€æµ‹ä¸­...</div>
            <button class="btn-control" onclick="toggleFan()">ğŸ› ï¸ æ‰‹åŠ¨åˆ‡æ¢é£æ‰‡</button>
        </div>
    </div>

    <div id="main"></div>
</div>

<script type="text/javascript">
    // --- ECharts åˆå§‹åŒ– ---
    var myChart = echarts.init(document.getElementById('main'));
    var option = {
        title: { text: 'æ¸©æ¹¿åº¦å®æ—¶è¶‹åŠ¿ (è‡ªåŠ¨åˆ·æ–°)' },
        tooltip: { trigger: 'axis' },
        legend: { data: ['æ¸©åº¦ (Â°C)', 'æ¹¿åº¦ (%)'] },
        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
        xAxis: { type: 'category', data: [] },
        yAxis: { type: 'value' },
        series: [
            { name: 'æ¸©åº¦ (Â°C)', type: 'line', smooth: true, data: [], color: '#ff4d4f', areaStyle: { opacity: 0.1 } },
            { name: 'æ¹¿åº¦ (%)', type: 'line', smooth: true, data: [], color: '#4096ff', areaStyle: { opacity: 0.1 } }
        ]
    };
    myChart.setOption(option);

    // --- æ ¸å¿ƒé€»è¾‘ ---
    function fetchData() {
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                if (!data || data.length === 0) return;

                // ğŸš¨ã€å…³é”®ä¿®å¤ã€‘ä¸ç®¡åç«¯ç»™ä»€ä¹ˆé¡ºåºï¼Œå‰ç«¯å¼ºåˆ¶æŒ‰ ID ä»å°åˆ°å¤§æ’åº (Old -> New)
                // è¿™æ ·èƒ½ä¿è¯ data[0] æ˜¯æœ€æ—§çš„ï¼Œdata[æœ€å] æ˜¯æœ€æ–°çš„
                data.sort((a, b) => a.id - b.id);

                // 1. æ‹¿åˆ°æœ€æ–°çš„ä¸€æ¡æ•°æ® (ç°åœ¨ä¸€å®šæ˜¯æœ€åä¸€ä¸ªäº†)
                var latest = data[data.length - 1];

                // æ›´æ–°é¡¶éƒ¨çš„æ•°å­—å¡ç‰‡
                document.getElementById('currentTemp').innerText = latest.temp + " Â°C";
                document.getElementById('currentHumi').innerText = latest.humi + " %";

                // 2. çŠ¶æ€åˆ¤æ–­é€»è¾‘
                var statusDiv = document.getElementById('fanStatus');
                if (latest.temp > 26.0) {
                    statusDiv.innerText = "ğŸ”¥ å¼€å¯é™æ¸©";
                    statusDiv.className = "value fan-on";
                } else {
                    statusDiv.innerText = "ğŸƒ å¾…æœºä¸­";
                    statusDiv.className = "value fan-off";
                }

                // 3. æ›´æ–°å›¾è¡¨ (å–æœ€å 20 æ¡ï¼Œä¹Ÿå°±æ˜¯æœ€æ–°çš„ 20 æ¡)
                var recentData = data.slice(-20);

                var times = recentData.map(item => item.createTime.replace("T", " ").substring(11, 19));
                var temps = recentData.map(item => item.temp);
                var humis = recentData.map(item => item.humi);

                myChart.setOption({
                    xAxis: { data: times },
                    series: [{ data: temps }, { data: humis }]
                });
            })
            .catch(error => console.error('Error:', error));
    }

    // --- æ‰‹åŠ¨æ§åˆ¶åŠŸèƒ½ ---
    function toggleFan() {
        var currentText = document.getElementById('fanStatus').innerText;
        alert("æŒ‡ä»¤å·²å‘é€ï¼(éœ€åç«¯æ”¯æŒ)\nå½“å‰çŠ¶æ€: " + currentText);
    }

    // å¯åŠ¨å®šæ—¶å™¨ (æ¯ 2 ç§’åˆ·æ–°ä¸€æ¬¡)
    fetchData();
    setInterval(fetchData, 2000);

    window.onresize = function() {
        myChart.resize();
    };
</script>
</body>
</html>